{
  "openapi": "3.0.3",
  "info": {
    "title": "FluxPayroll API",
    "description": "API for calculating gross-to-net payroll calculations across different countries. Currently supports Mexico with ISR, IMSS, INFONAVIT, and state-level payroll tax calculations.",
    "version": "2.0.0",
    "contact": {
      "name": "FluxPayroll",
      "url": "https://fluxpayroll.ai"
    }
  },
  "servers": [
    {
      "url": "https://api.staging.fluxpayroll.ai",
      "description": "Staging"
    }
  ],
  "paths": {
    "/api/mexico-payroll/calculate": {
      "post": {
        "summary": "Calculate payroll (G2N)",
        "description": "Calculates gross-to-net payroll for an array of employees, including all Mexican taxes (ISR, IMSS, INFONAVIT). Returns detailed breakdown of employee and employer taxes for each employee.",
        "operationId": "calculateMexicoPayroll",
        "tags": ["Mexico Payroll"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CalculatePayrollRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful payroll calculation",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CalculatePayrollResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing authentication token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error during calculation",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/mexico-payroll/calculate-with-derived-earnings": {
      "post": {
        "summary": "Calculate payroll (G2N) with auto-generated earnings",
        "description": "Calculates gross-to-net payroll by first generating earnings from time entries and compensation, then calculating all Mexican taxes. This endpoint accepts time entries (start/end times per day) and compensation (daily/weekly/monthly/annual) and automatically derives earnings like SALARY, DOUBLE_OVERTIME, and TRIPLE_OVERTIME.",
        "operationId": "calculateMexicoPayrollWithDerivedEarnings",
        "tags": ["Mexico Payroll"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CalculateWithDerivedEarningsRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful payroll calculation with derived earnings",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CalculatePayrollResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input data (e.g., time entries outside payroll period, invalid time format)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing authentication token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error during calculation",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/mexico-payroll/earnings": {
      "get": {
        "summary": "Get all available earnings for Mexico",
        "description": "Returns a list of all earning types available for Mexico payroll calculations (e.g., SALARY, DOUBLE_OVERTIME, XMAS, VACATION_PREMIUM, etc.).",
        "operationId": "getMexicoEarnings",
        "tags": ["Mexico Payroll"],
        "responses": {
          "200": {
            "description": "List of available earning types",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/EarningResponse"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing authentication token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/mexico-payroll/generate-earnings": {
      "post": {
        "summary": "Generate earnings from time entries and compensation",
        "description": "Generates earnings (SALARY, DOUBLE_OVERTIME, TRIPLE_OVERTIME, SUNDAY_PREMIUM, VACATION_PREMIUM) from time entries and compensation data. This endpoint does NOT calculate taxes â€” it only returns the generated earnings and calculated daily wage for each employee. Useful for previewing earnings before running full payroll calculations.",
        "operationId": "generateMexicoEarnings",
        "tags": ["Mexico Payroll"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GenerateEarningsRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successfully generated earnings",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GenerateEarningsResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input data (e.g., time entries outside payroll period, invalid time format)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - Invalid or missing authentication token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error during generation",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "security": [
    {
      "apiKey": []
    }
  ],
  "components": {
    "securitySchemes": {
      "apiKey": {
        "type": "apiKey",
        "name": "x-api-key",
        "in": "header"
      }
    },
    "schemas": {
      "CalculatePayrollRequest": {
        "type": "object",
        "required": ["employees", "payrollConfig"],
        "additionalProperties": false,
        "properties": {
          "employees": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EmployeeInput"
            },
            "minItems": 1,
            "description": "Array of employees to process"
          },
          "payrollConfig": {
            "$ref": "#/components/schemas/PayrollConfig"
          }
        }
      },
      "EmployeeInput": {
        "type": "object",
        "required": ["employeeId", "employeeStartDate", "dailyWage", "earnings", "previousBimesterEarnigs", "workAddress"],
        "additionalProperties": false,
        "properties": {
          "employeeId": {
            "type": "string",
            "description": "Unique employee identifier",
            "example": "emp-basic-salary-001"
          },
          "employeeStartDate": {
            "type": "string",
            "format": "date",
            "description": "Employee hire date in ISO 8601 format",
            "example": "2020-01-01"
          },
          "dailyWage": {
            "type": "number",
            "minimum": 0,
            "description": "Daily wage in MXN",
            "example": 500
          },
          "earnings": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EarningInput"
            },
            "description": "Array of earnings for the payroll period"
          },
          "previousBimesterEarnigs": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EarningInput"
            },
            "default": [],
            "description": "Previous 2 months of earnings used for SBC (Salary Base for Contributions) calculation"
          },
          "workerRiskClass": {
            "type": "string",
            "enum": ["I", "II", "III", "IV", "V"],
            "default": "I",
            "description": "IMSS worker risk class. Defaults to 'I' if not specified."
          },
          "workAddress": {
            "$ref": "#/components/schemas/WorkAddress"
          }
        }
      },
      "EarningInput": {
        "type": "object",
        "required": ["earningCode", "amount"],
        "additionalProperties": false,
        "properties": {
          "earningCode": {
            "type": "string",
            "description": "Earning type code (e.g., SALARY, DOUBLE_OVERTIME, XMAS, VACATION_PREMIUM)",
            "example": "SALARY"
          },
          "amount": {
            "type": "number",
            "minimum": 0,
            "description": "Earning amount in MXN",
            "example": 15000
          }
        }
      },
      "PayrollConfig": {
        "type": "object",
        "required": ["startDate", "endDate", "period"],
        "additionalProperties": false,
        "properties": {
          "startDate": {
            "type": "string",
            "format": "date",
            "description": "Payroll period start date in ISO 8601 format",
            "example": "2025-09-01"
          },
          "endDate": {
            "type": "string",
            "format": "date",
            "description": "Payroll period end date in ISO 8601 format",
            "example": "2025-09-30"
          },
          "period": {
            "type": "string",
            "enum": ["DAILY", "WEEKLY", "MONTHLY", "QUARTERLY", "SEMI_ANNUAL", "ANNUAL"],
            "description": "Payroll frequency",
            "example": "MONTHLY"
          }
        }
      },
      "WorkAddress": {
        "type": "object",
        "required": ["state"],
        "additionalProperties": false,
        "properties": {
          "state": {
            "type": "string",
            "description": "Mexican state code (e.g., AGU, BCN, CMX, JAL, MEX, NLE, etc.)",
            "example": "AGU"
          }
        }
      },
      "CalculateWithDerivedEarningsRequest": {
        "type": "object",
        "required": ["employees", "payrollConfig"],
        "additionalProperties": false,
        "properties": {
          "employees": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EmployeeGeneratorInput"
            },
            "minItems": 1,
            "description": "Array of employees with time entries and compensation"
          },
          "payrollConfig": {
            "$ref": "#/components/schemas/PayrollConfig"
          },
          "fillDefaultSchedule": {
            "type": "boolean",
            "default": false,
            "description": "When true, auto-fills default time entries (standard work hours) for work days missing from employee timeEntries"
          }
        }
      },
      "EmployeeGeneratorInput": {
        "type": "object",
        "required": ["employeeId", "employeeStartDate", "compensation", "timeEntries", "previousBimesterEarnigs", "workAddress", "earnings"],
        "additionalProperties": false,
        "properties": {
          "employeeId": {
            "type": "string",
            "description": "Unique employee identifier",
            "example": "emp-001"
          },
          "employeeStartDate": {
            "type": "string",
            "format": "date",
            "description": "Employee hire date in ISO 8601 format",
            "example": "2020-01-01"
          },
          "compensation": {
            "$ref": "#/components/schemas/CompensationInput"
          },
          "timeEntries": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TimeEntry"
            },
            "default": [],
            "description": "Work shifts for the payroll period"
          },
          "previousBimesterEarnigs": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EarningInput"
            },
            "default": [],
            "description": "Previous 2 months of earnings for SBC calculation"
          },
          "workerRiskClass": {
            "type": "string",
            "enum": ["I", "II", "III", "IV", "V"],
            "default": "I",
            "description": "IMSS worker risk class"
          },
          "workAddress": {
            "$ref": "#/components/schemas/WorkAddress"
          },
          "earnings": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EarningInput"
            },
            "description": "Non-derived earnings (e.g., bonuses) to include alongside generated earnings"
          }
        }
      },
      "CompensationInput": {
        "type": "object",
        "required": ["type", "amount"],
        "additionalProperties": false,
        "properties": {
          "type": {
            "type": "string",
            "enum": ["daily", "weekly", "monthly", "annual"],
            "description": "Compensation frequency type",
            "example": "monthly"
          },
          "amount": {
            "type": "number",
            "minimum": 0,
            "description": "Salary amount in MXN",
            "example": 15000
          }
        }
      },
      "TimeEntry": {
        "type": "object",
        "required": ["date", "startTime", "endTime"],
        "additionalProperties": false,
        "properties": {
          "date": {
            "type": "string",
            "format": "date",
            "description": "Work date in ISO 8601 format",
            "example": "2025-09-01"
          },
          "startTime": {
            "type": "string",
            "pattern": "^([01]\\d|2[0-3]):[0-5]\\d$",
            "description": "Shift start time in HH:mm 24-hour format",
            "example": "09:00"
          },
          "endTime": {
            "type": "string",
            "pattern": "^([01]\\d|2[0-3]):[0-5]\\d$",
            "description": "Shift end time in HH:mm 24-hour format",
            "example": "17:00"
          },
          "dayOffType": {
            "type": "string",
            "enum": ["sick", "vacation", "absent", "work_illness"],
            "description": "Type of day off, if applicable"
          }
        },
        "example": {
          "date": "2025-09-01",
          "startTime": "09:00",
          "endTime": "17:00"
        }
      },
      "GenerateEarningsRequest": {
        "type": "object",
        "required": ["employees", "payrollConfig"],
        "additionalProperties": false,
        "properties": {
          "employees": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/GenerateEarningsEmployeeInput"
            },
            "minItems": 1,
            "description": "Array of employees with time entries and compensation"
          },
          "payrollConfig": {
            "$ref": "#/components/schemas/PayrollConfig"
          },
          "fillDefaultSchedule": {
            "type": "boolean",
            "default": false,
            "description": "When true, auto-fills default time entries (standard work hours) for work days missing from employee timeEntries"
          }
        }
      },
      "GenerateEarningsEmployeeInput": {
        "type": "object",
        "required": ["employeeId", "employeeStartDate", "compensation", "timeEntries", "workAddress"],
        "additionalProperties": false,
        "properties": {
          "employeeId": {
            "type": "string",
            "description": "Unique employee identifier",
            "example": "emp-001"
          },
          "employeeStartDate": {
            "type": "string",
            "format": "date",
            "description": "Employee hire date in ISO 8601 format",
            "example": "2020-01-01"
          },
          "compensation": {
            "$ref": "#/components/schemas/CompensationInput"
          },
          "timeEntries": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TimeEntry"
            },
            "default": [],
            "description": "Work shifts for the payroll period"
          },
          "workAddress": {
            "$ref": "#/components/schemas/WorkAddress"
          }
        }
      },
      "CalculatePayrollResponse": {
        "type": "object",
        "required": ["results"],
        "properties": {
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PayrollResult"
            },
            "description": "Array of payroll results, one per employee"
          }
        }
      },
      "PayrollResult": {
        "type": "object",
        "required": ["employeeId", "grossPay", "employeeTaxes", "employerTaxes", "netPay", "totalEmployerTax", "totalEmployerContributions", "totalEmployeeTax", "totalEmployeeContributions", "dailySbc"],
        "properties": {
          "employeeId": {
            "type": "string",
            "description": "Employee identifier",
            "example": "emp-basic-salary-001"
          },
          "grossPay": {
            "type": "string",
            "description": "Total gross earnings for the period",
            "example": "15000.00"
          },
          "employeeTaxes": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/TaxResult"
            },
            "description": "Breakdown of employee taxes (ISR, IMSS components, etc.)"
          },
          "employerTaxes": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/TaxResult"
            },
            "description": "Breakdown of employer taxes and contributions"
          },
          "netPay": {
            "type": "string",
            "description": "Net pay after all employee taxes and deductions",
            "example": "13250.45"
          },
          "totalEmployerTax": {
            "type": "string",
            "description": "Total employer taxes (taxType = TAX)",
            "example": "450.00"
          },
          "totalEmployerContributions": {
            "type": "string",
            "description": "Total employer contributions (taxType = CONTRIBUTIONS)",
            "example": "2100.50"
          },
          "totalEmployeeTax": {
            "type": "string",
            "description": "Total employee taxes",
            "example": "1749.55"
          },
          "totalEmployeeContributions": {
            "type": "string",
            "description": "Total employee contributions",
            "example": "350.00"
          },
          "dailySbc": {
            "type": "string",
            "description": "Daily SBC (Salary Base for Contributions) utilized for IMSS calculations",
            "example": "520.55"
          }
        }
      },
      "TaxResult": {
        "type": "object",
        "required": ["wageBase", "taxAmount"],
        "properties": {
          "wageBase": {
            "type": "string",
            "description": "Taxable income base for this tax",
            "example": "15000.00"
          },
          "taxAmount": {
            "type": "string",
            "description": "Calculated tax amount",
            "example": "1200.50"
          },
          "subsidy": {
            "type": "string",
            "description": "Tax subsidy amount, if applicable (e.g., employment subsidy for ISR)",
            "example": "0.00"
          }
        }
      },
      "EarningResponse": {
        "type": "object",
        "required": ["key", "country", "name", "description", "requiresManualInput"],
        "properties": {
          "key": {
            "type": "string",
            "description": "Unique earning code",
            "example": "SALARY"
          },
          "country": {
            "type": "string",
            "description": "ISO country code",
            "example": "MX"
          },
          "name": {
            "type": "string",
            "description": "Display name of the earning",
            "example": "Salario Base"
          },
          "description": {
            "type": "string",
            "description": "Detailed description of the earning type"
          },
          "requiresManualInput": {
            "type": "boolean",
            "description": "Whether this earning requires manual input (true for bonuses, false for auto-derived earnings like overtime)",
            "example": true
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Creation timestamp"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Last update timestamp"
          }
        }
      },
      "GenerateEarningsResponse": {
        "type": "object",
        "required": ["results"],
        "properties": {
          "results": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EmployeeEarningsOutput"
            },
            "description": "Array of generated earnings per employee"
          }
        }
      },
      "EmployeeEarningsOutput": {
        "type": "object",
        "required": ["employeeId", "dailyWage", "earnings"],
        "properties": {
          "employeeId": {
            "type": "string",
            "description": "Employee identifier",
            "example": "emp-001"
          },
          "dailyWage": {
            "type": "number",
            "description": "Calculated daily wage in MXN",
            "example": 500
          },
          "earnings": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/EarningOutput"
            },
            "description": "Generated earnings for the payroll period"
          }
        }
      },
      "EarningOutput": {
        "type": "object",
        "required": ["earningCode", "amount"],
        "properties": {
          "earningCode": {
            "type": "string",
            "description": "Earning type code",
            "example": "SALARY"
          },
          "amount": {
            "type": "number",
            "description": "Earning amount in MXN",
            "example": 15000
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": ["error", "message"],
        "properties": {
          "error": {
            "type": "string",
            "description": "Error code",
            "example": "VALIDATION_ERROR"
          },
          "message": {
            "type": "string",
            "description": "Human-readable error message",
            "example": "Invalid input data provided"
          },
          "details": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "field": {
                  "type": "string",
                  "description": "Field that caused the error"
                },
                "message": {
                  "type": "string",
                  "description": "Specific error message for the field"
                }
              }
            }
          }
        }
      }
    }
  }
}
